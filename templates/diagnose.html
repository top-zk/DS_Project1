{% extends "base.html" %}

{% block title %}智能诊断 - 智能医疗诊断助手{% endblock %}

{% block styles %}
<style>
    /* Specific styles for diagnose page */
    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        background: #ffffff;
        margin-bottom: 24px;
        transition: transform 0.2s;
    }
    
    /* Input Section */
    textarea.form-control {
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 16px;
        font-size: 1rem;
        resize: vertical;
        background-color: #fbfbfb;
        transition: all 0.3s;
    }
    textarea.form-control:focus {
        background-color: #ffffff;
        border-color: var(--medical-blue);
        box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.1);
    }

    /* Result Section */
    .result-header {
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 16px;
        margin-bottom: 20px;
    }
    .result-title {
        color: var(--text-muted);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }
    .result-value {
        color: var(--medical-blue);
        font-size: 1.5rem;
        font-weight: 700;
    }
    .confidence-badge {
        background-color: var(--medical-light);
        color: var(--medical-blue);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
        margin-top: 8px;
    }

    /* Progress Bars */
    .progress-label {
        font-size: 0.9rem;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
    }
    .progress {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        margin-bottom: 16px;
    }
    .progress-bar {
        background-color: var(--medical-blue);
        border-radius: 4px;
    }
    
    /* Low probability items */
    .low-prob-container {
        margin-top: 20px;
        border-top: 1px solid #f0f0f0;
        padding-top: 16px;
    }
    .low-prob-toggle {
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .low-prob-toggle:hover {
        color: var(--medical-blue);
    }
    .low-prob-item {
        opacity: 0.7;
    }
    .low-prob-item .progress-bar {
        background-color: #adb5bd;
    }

    /* Offcanvas */
    .offcanvas {
        top: var(--navbar-height) !important;
        height: calc(100vh - var(--navbar-height)) !important;
    }
    .offcanvas-backdrop {
        top: var(--navbar-height) !important;
        height: calc(100vh - var(--navbar-height)) !important;
    }
    
    .history-item {
        cursor: pointer;
        padding: 10px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }
    .history-item:hover {
        background-color: #f8f9fa;
    }
    .history-date {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .history-text {
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #343a40;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Main Layout -->
    <div class="row justify-content-center">

        <!-- Left Column: Input -->
        <div class="col-lg-5 col-md-6">
            <div class="card h-100">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-stethoscope me-2 text-primary"></i>症状描述
                        </h4>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#historySidebar" aria-controls="historySidebar">
                            <i class="fas fa-history me-1"></i> 历史记录
                        </button>
                    </div>
                    <form action="{{ url_for('predict') }}" method="post" class="flex-grow-1 d-flex flex-column">
                        <div class="mb-3 flex-grow-1 d-flex flex-column">
                            <textarea class="form-control flex-grow-1" name="symptoms" 
                                placeholder="请详细描述您的症状，例如：&#10;最近两天感觉头痛，伴有轻微发烧，喉咙痛，浑身乏力..."
                                required minlength="10">{% if result %}{{ result.text }}{% elif symptoms_input %}{{ symptoms_input }}{% endif %}</textarea>
                            <div class="form-text text-muted mt-2">请至少输入10个字，以便AI更准确地分析。</div>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-medical btn-lg">
                                <i class="fas fa-search-plus me-2"></i>开始智能诊断
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="document.querySelector('textarea').value=''">
                                <i class="fas fa-eraser me-2"></i>清空内容
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Results -->
        <div class="col-lg-5 col-md-6">
            {% if result %}
            <div class="card h-100 fade-in">
                <div class="card-body p-4">
                    <h4 class="card-title mb-4">
                        <i class="fas fa-clipboard-check me-2 text-success"></i>诊断结果
                    </h4>
                    
                    <div class="row mb-4">
                        <div class="col-6">
                            <div class="result-header">
                                <div class="result-title">预测疾病类型</div>
                                <div class="result-value">{{ result.type_name }}</div>
                                <span class="confidence-badge">
                                    置信度: {{ (result.prob * 100)|round(1) }}%
                                </span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="result-header">
                                <div class="result-title">推荐就诊科室</div>
                                <div class="result-value text-dark">{{ result.department }}</div>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3">可能性分析</h5>
                    <!-- High Probability Items -->
                    {% for p in result.probs %}
                        {% if p > 0.01 %}
                        <div class="progress-label">
                            <span>{{ types[loop.index0] }}</span>
                            <span>{{ (p * 100)|round(1) }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ p * 100 }}%; opacity: {{ 0.5 + p/2 }};" 
                                 aria-valuenow="{{ p * 100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        {% endif %}
                    {% endfor %}

                    <!-- Low Probability Items (Collapsible) -->
                    <div class="low-prob-container">
                        <a class="low-prob-toggle" data-bs-toggle="collapse" href="#lowProbList" role="button" aria-expanded="false" aria-controls="lowProbList">
                            <i class="fas fa-chevron-down"></i> 显示低概率结果
                        </a>
                        <div class="collapse mt-3" id="lowProbList">
                            {% for p in result.probs %}
                                {% if p <= 0.01 %}
                                <div class="progress-label low-prob-item">
                                    <span>{{ types[loop.index0] }}</span>
                                    <span>{{ (p * 100)|round(2) }}%</span>
                                </div>
                                <div class="progress low-prob-item">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {{ p * 100 }}%;" 
                                         aria-valuenow="{{ p * 100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                </div>
            </div>
            {% else %}
            <!-- Placeholder/Instruction when no result -->
            <div class="card h-100 d-flex align-items-center justify-content-center text-center p-5 text-muted">
                <div>
                    <i class="fas fa-user-md fa-4x mb-3 text-secondary" style="opacity: 0.3;"></i>
                    <h5>等待输入</h5>
                    <p>请在左侧输入您的症状描述，<br>AI助手将为您分析。</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- History Sidebar (Desktop: always visible? No, let's make it an offcanvas for everyone or a column) 
             The original design had it as an offcanvas. Let's keep it as offcanvas but accessible via a floating button or nav item if needed.
             Wait, I didn't see a history button in my navbar. Let's add a floating button or just rely on the navbar? 
             Actually, let's put it in a column if screen is large enough? No, let's stick to offcanvas to save space.
        -->
    </div>
</div>

<!-- History Offcanvas -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="historySidebar" aria-labelledby="historySidebarLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="historySidebarLabel">诊断历史</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="historyList">
            <!-- JS will populate this -->
            <p class="text-muted text-center mt-4">暂无历史记录</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Simple LocalStorage History Management
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const historyList = document.getElementById('historyList');
        
        // Load history
        loadHistory();

        if(form) {
            form.addEventListener('submit', function(e) {
                const text = document.querySelector('textarea').value.trim();
                
                // Client-side validation
                if(text.length < 10) {
                    e.preventDefault();
                    alert('描述过于简单，请至少提供3个相关的症状描述（或10个字以上）');
                    return;
                }

                if(text) {
                    saveHistory(text);
                }
            });
        }

        function saveHistory(text) {
            let history = JSON.parse(localStorage.getItem('medical_history') || '[]');
            const newItem = {
                text: text,
                date: new Date().toLocaleString()
            };
            history.unshift(newItem);
            if(history.length > 20) history.pop(); // Keep last 20
            localStorage.setItem('medical_history', JSON.stringify(history));
        }

        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('medical_history') || '[]');
            if(history.length === 0) return;

            historyList.innerHTML = '';
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-date">${item.date}</div>
                    <div class="history-text">${item.text}</div>
                `;
                div.onclick = () => {
                    const textarea = document.querySelector('textarea');
                    if(textarea) {
                        textarea.value = item.text;
                        // Close sidebar
                        const bsOffcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('historySidebar'));
                        if(bsOffcanvas) bsOffcanvas.hide();
                    }
                };
                historyList.appendChild(div);
            });
        }
    });
</script>
{% endblock %}